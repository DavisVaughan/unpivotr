---
title: "ian branch outline"
date: "28/04/2019"
output:   
  html_document:
    keep_html: true
editor_options: 
  chunk_output_type: console
---

```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tibble.print_min = 100, tibble.print_max = 100)
rm(list = ls())
options(width=100)
```


```{r message=FALSE, warning=FALSE, include=FALSE}
library(devtools)

install_github("nacnudus/unpivotr",ref = "ian")
library(unpivotr)

library(magick)
library(magrittr)
library(tidyverse)
library(tidyxl)
library(stringr)

```

### New functions

This document outlines the functions introduced to `unpivotr` by the `ian` branch on gituhub. 

The `ian` branch adds two main functions.

* **`unpivotr::orientate / unpivotr::orientate_auto`** takes a tidyxl spreadsheet and adds three columns. **`.header_group`** indicates the header group to which the cell belongs, **`.orientation`** indicates whether the contents of the cell belong to a data or header section of the table. (If the cell belongs to a header section, the value of `.orientation` takes on the orientation of the header with respect to the data), **`.value`** represents the contents of the cell (This will differ from the from the valued presented in the tidyxl dataframe when the cell is part of a merge.)

* **`unpivotr::migrate`** takes the data frame produced by `unpivotr::orientate / unpivotr::orientate_auto` and converts it into a data frame with one row per data cell and one column per header.

### Example

Take the following excel table:  

```{r echo=FALSE, fig.height=20, fig.width=20, message=FALSE, warning=FALSE}
magick::image_read("https://unpivotr.s3.amazonaws.com/worked-examples_clean.png")
```

We can use `tidyxl::xlsx_cells` to read this table as a tidyxl data frame and `tidyxl::xlsx_formats` to read in its format information:

```{r message=FALSE, warning=FALSE}
# Get path to workbook.
workbook_path <- unpivotr_example("worked-examples.xlsx")

# Read in tidyxl data frame.
testsheet_df <- xlsx_cells(path = workbook_path, sheets = "clean")

# Read in formats.
format <- xlsx_formats(workbook_path)

# Show selected columns.
testsheet_df %>% select(row,col,character,numeric) 

```

**`unpivotr::orientate / unpivotr::orientate_auto`** then add **`.header_group`**, **`.orientation`** and **`.value`** variables. 

**`unpivotr::orientate_auto`** detects this information automatically. 

```{r message=FALSE, warning=FALSE}

# Show selected columns.
(auto_orientated_df <- testsheet_df %>% orientate_auto(formats = format) %>%  
  select(row,col,character,numeric,.header_group, .orientation, .value))

```

**`unpivotr::orientate`** takes a named string vector to add this information manually. 

```{r message=FALSE, warning=FALSE}

# Create named vector indicating orientations.
orientation <- c("B2:B4"="data", "B1" = "N", "A2:A4"="W")

# Show selected columns.
(orientated_df <- testsheet_df %>% orientate(orientations = orientation) %>%  
  select(row,col,character,numeric,.header_group, .orientation, .value))

```

 **`unpivotr::migrate`** reshapes the tidyxl data frame to have one row per data cell and one column per header. 
 
```{r message=FALSE, warning=FALSE}
# Reshape oriented dataframe.
orientated_df %>% migrate()

# Reshape auto-oriented dataframe.
auto_orientated_df %>% migrate()

```
 
### Alternative function names 

* **`orientate / orientate_auto`**
  + **`declare_directions / deduce_directions`**
  + **`direct / direct_auto`**
  
* **`migrate`**
  + **`enhead_all`**
  + **`enhead_enmasse`**
  + **`enhead_df`**

### More detail 

* the behaviour of the **`orientate_auto`** function can be altered with the following arguments:
  + `group_col_headers_by` / `group_row_headers_by` takes a vector of strings that correspond to the formats: "indenting" "bolding" "italics" "text_color" "bg_color" "h_alignment". Headers are grouped according to these nominated cell formats.
  + `col_header_fill` / `row_header_fill` determine how/whether blank cells in header sections of the table are delt with. Blank cells can be filled according to  "local_format_id","style","borders" or  "none" (not filled at all).

