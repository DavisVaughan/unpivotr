---
title: "Examples"
author: "Ian Moran"
date: "28/04/2019"
output:   
  html_document
editor_options: 
  chunk_output_type: console
---


```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tibble.print_min = 100, tibble.print_max = 100)
options(width=100)
```

#### Setup packages 
```{r message=FALSE, warning=FALSE, include=FALSE}
# Clear environment 
rm(list = ls())
install.packages("pacman");
library("pacman")
(p_load(here,stringr,purrr,dplyr,rlang,magrittr,ggplot2,cowplot,plotly,
       unpivotr, magick, magrittr, tidyverse, stringr, rlang, lubridate,
       hrbrthemes, scales, devtools,rlang))
# Load all packages 
devtools::load_all(file.path(dirname(here::here()),"tidyxl"))
devtools::load_all(here::here())
```

## Spreadsheets from worked-examples.xlsx

#### clean


```{r echo=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
magick::image_read("https://unpivotr.s3.amazonaws.com/worked-examples_clean.png")
```


```{r message=FALSE, warning=FALSE}

unpivotr_example("worked-examples.xlsx") %>% 
 xlsx_cells_fmt(sheets = "clean") %>% 
  locate_data() %>% 
  locate_header_groups(type = "row") %>% 
  locate_header_groups(type = "col") %>% 
  migrate()

```



#### notes

```{r message=FALSE, warning=FALSE}

unpivotr_example("worked-examples.xlsx") %>% 
  xlsx_cells_fmt(sheets = "notes") %>% 
  locate_data() %>% 
  locate_header_groups(type = "both") %>% 
  migrate()

unpivotr_example("worked-examples.xlsx") %>% 
  xlsx_cells_fmt(sheets = "notes") %>% 
  locate_data() %>% 
  locate_header_groups(type = "both") %>% 
  locate_header_groups(type = "meta") %>% 
  migrate()

```


#### pivot-annotations

```{r message=FALSE, warning=FALSE}

unpivotr_example("worked-examples.xlsx") %>% 
  xlsx_cells_fmt(sheets = "pivot-annotations") %>% 
  locate_data() %>% 
  locate_header_groups(type = "both",header_fill = "style") %>% 
  migrate()

```

#### pivot-centre-aligned


```{r message=FALSE, warning=FALSE}

unpivotr_example("worked-examples.xlsx") %>% 
  xlsx_cells_fmt(sheets = "pivot-centre-aligned") %>% 
  locate_data() %>% 
  locate_header_groups(type = "both",header_fill = "borders") %>% 
  migrate()

```

#### pivot-notes
**Note: Add option to ignore specified cells.**

```{r message=FALSE, warning=FALSE}

unpivotr_example("worked-examples.xlsx") %>% 
  xlsx_cells_fmt(sheets = "pivot-notes") %>% 
  locate_data() %>% 
  locate_header_groups(type = "row",header_fill = "borders",
                          .groupings = groupings(fmt_font_color_rgb),
                          default_row_header_direction = "WNW") %>%
  migrate
```

#### pivot-hierarchy

```{r message=FALSE, warning=FALSE}

unpivotr_example("worked-examples.xlsx") %>% 
  xlsx_cells_fmt(sheets = "pivot-hierarchy") %>% 
  locate_data() %>% 
  locate_header_groups(type = "both",header_fill = "borders",
                          .groupings = groupings(fmt_alignment_indent))%>%
  migrate()

```


```{r message=FALSE, warning=FALSE}

unpivotr_example("worked-examples.xlsx") %>% 
  xlsx_cells_fmt(sheets = "implied-multiples") %>% 
  locate_data(col > 1 & row >2) %>% 
  locate_header_groups(type = "both",header_fill = "style")%>%
  migrate()

```





#### pivot-repeated-headers

```{r message=FALSE, warning=FALSE}
sheet_name <- "pivot-repeated-headers"
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

get_table <- function(range) {
  orientate_auto(
    sheet = testsheet_df, formats = formats,
    table_range = range, row_header_fill = "style"
  ) %>% migrate()
}

c("B2:F6", "B7:F11", "B12:F16", "B17:F21") %>%  map_dfr(get_table) 
```


#### pivot-header-within-data

```{r message=FALSE, warning=FALSE}

sheet_name <- "pivot-header-within-data"
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

get_table <- function(x) {
  orientate_auto(
    sheet = testsheet_df, formats = formats,
    table_range = x, col_header_fill = "style"
  ) %>% migrate()
}

c("B2:E7", "B8:E13", "B14:E19", "B20:E25") %>% map_dfr(get_table)
```

#### small-multiples

```{r message=FALSE, warning=FALSE}
sheet_name <- "small-multiples"
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

table_ranges <- "A1:C4,E1:G4,A6:C9,E6:G9" %>% strsplit(",") %>% unlist()
data_ranges <- "B3:C4,F3:G4,B8:C9,F8:G9" %>% strsplit(",") %>% unlist()

get_table <- function(table_ref, values_ref) {
  orientate_auto(
    sheet = testsheet_df, formats = formats,
    table_range = table_ref, manual_value_references = values_ref,
    keep_meta_data = TRUE
  ) %>% migrate()
}

map2_dfr(table_ranges, data_ranges, get_table)
```

#### humanities

```{r message=FALSE, warning=FALSE}
sheet_name <- "humanities"
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

orientated_df_auto <- orientate_auto(sheet = testsheet_df,formats = formats)

orientated_df_auto %>% migrate()
```

#### performance

```{r message=FALSE, warning=FALSE}

sheet_name <- "performance"
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

orientated_df_auto <-  orientate_auto(sheet = testsheet_df,formats = formats)

orientated_df_auto %>% migrate()

```

#### worked-examples

```{r message=FALSE, warning=FALSE}

workbook_path <- unpivotr_example("worked-examples.xlsx")
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

orientated_df_auto <- orientate_auto(sheet = testsheet_df,formats = formats)

orientated_df_auto %>% migrate()
```

#### male

```{r message=FALSE, warning=FALSE}
sheet_name <- "male"
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

orientated_df_auto <- orientate_auto(sheet = testsheet_df,formats = formats)

orientated_df_auto %>% migrate()
```

#### implied-multiples

```{r message=FALSE, warning=FALSE}
sheet_name <- "implied-multiples"
testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)

orientated_df_auto <-
  orientate_auto(
    sheet = testsheet_df,formats = formats,
    col_header_fill = "style", default_col_header_direction = "NNW"
  )

orientated_df_auto %>% migrate()

```

## ABS Spreadsheets 

#### australian-industry

```{r message=FALSE, warning=FALSE}
workbook_path <- unpivotr_example("australian-industry.xlsx")
sheet_name <- "Table_1"

testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)
formats <- xlsx_formats(workbook_path)

orientated_df_auto <- orientate_auto(sheet = testsheet_df,formats = formats)

orientated_df_auto %>% migrate()
```

#### consumer-price-index


```{r message=FALSE, warning=FALSE}

workbook_path <- unpivotr_example("consumer-price-index.xlsx")
sheet_name <- "Data1"

testsheet_df <- xlsx_cells(path = workbook_path, sheets = sheet_name)
formats <- xlsx_formats(workbook_path)

orientated_df_auto <- orientate_auto(sheet = testsheet_df,formats = formats) 

orientated_df_auto %>% migrate()
```


