---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

# unpivotr

Tools for converting data from complex or irregular layouts to a columnar
structure.  For example, tables with multi-level column or row headers, or
spreadsheets.  Header and data cells are selected by their contents, position
and formatting, and are associated with one other by their relative positions.

## Example

```{r, echo = TRUE}
library(unpivotr)
library(tidyxl)
library(readxl)
library(dplyr)
```

The package includes a spreadsheet, 'purpose.xlsx', which has tables that have
multi-row column headers and multi-column row-headers.  A popular package for
importing spreadsheets does the following:

```{r, echo = TRUE}
read_excel("./inst/extdata/purpose.xlsx", "NNW WNW")
```

The [tidyxl](https://github.com/nacnudus/tidyxl) package imports the same table
into a format suitable for unpivotr:

```{r, echo = TRUE}
(pivoted <- contents("./inst/extdata/purpose.xlsx", "NNW WNW")[[1]])
```

We can identify each row of column headers, each column of row headers, and the
data cells, using any method.  Here, we use some
[dplyr](https://github.com/hadley/dplyr) and some base R functions.

```{r, echo = TRUE}
col_headers <- 
  pivoted %>%
  filter(row <= 3, !is.na(content)) %>%
  select(row, col, header = character) %>%
  split(.$row)
col_headers 

row_headers <- 
  pivoted %>%
  filter(col <= 3, !is.na(content)) %>%
  select(row, col, header = character) %>%
  split(.$col)
row_headers

datacells <- 
  pivoted %>%
  filter(row >= 4, col >= 4) %>%
  select(row, col, value = as.integer(content))
datacells
```

Using `unpivotr` functions, we associate the data cells with the headers, by
proximity in given compass directions.

```{r, echo = TRUE}
unpivoted <- 
  datacells %>%
  NNW(col_headers[[1]], "sex") %>%
  N(col_headers[[2]], "purpose") %>%
  WNW(row_headers[[1]], "education") %>% 
  W(row_headers[[2]], "age")
unpivoted
```

We can re-pivot the final data in R using `ftable()` to check that it has been
imported correctly.

```{r, echo = TRUE}
ftable(unpivoted, 
       row.vars = c("education", "age"),
       col.vars = c("sex", "purpose"))
read_excel("./inst/extdata/purpose.xlsx", "NNW WNW")
```

The functions `extend()` and `offset` can be used when selecting cells relative
to an intial anchor cell (or group of cells, called a 'bag').

## Similar projects

[unpivotr](https://github.com/nacnudus/unpivotr) is inspired by the United
Kingdom Office of National Statistics
[ONSdatabaker](https://github.com/ONS-OpenData/ONSdatabaker), which is
implemented in Python.  [unpivotr](https://github.com/nacnudus/unpivotr) differs
already by using compass directions, and further developments are planned.

The [rsheets](https://github.com/rsheets) project of several R packages is in
the early stages of importing spreadsheet information from Excel and Google
Sheets into R, manipulating it, and potentially parsing and processing formulas
and writing out to spreadsheet files.  In particular,
[jailbreaker](https://github.com/rsheets/jailbreakr) attempts to extract
non-tabular data from spreadsheets into tabular structures automatically via
some clever algorithms.

[unpivot](https://github.com/nacnudus/unpivotr) differs from
[jailbreaker](https://github.com/rsheets/jailbreakr) in that it provides tools
for unpivoting complex and non-tabular data layouts using I not AI
(intelligence, not artificial intelligence).

## Roadmap

- [ ] Implement boundaries for the `ABOVE()`, `BELOW()`, `LEFT()`, `RIGHT()`
functions to search within boundaries for a header cell, e.g. within an area
bounded by borders.  This will make it possible in many cases to break ties
between header cells that are equidistant from a data cell.
