---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

# unpivotr

Tools for converting data from complex or irregular layouts to a columnar
structure.  For example, tables with multi-level column or row headers, or
spreadsheets.  Header and data cells are selected by their contents, position
and formatting, and are associated with one other by their relative positions.

## Example

```{r, echo = TRUE}
library(unpivotr)
library(tidyxl)
library(readxl)
library(dplyr)
```

The package includes a spreadsheet, 'purpose.xlsx', which has tables that have
multi-row column headers and multi-column row-headers.  A popular package for
importing spreadsheets does the following:

```{r, echo = TRUE}
read_excel("./inst/extdata/purpose.xlsx", "NNW WNW")
```

The [tidyxl](https://github.com/nacnudus/tidyxl) package imports the same table
into a format suitable for unpivotr:

```{r, echo = TRUE}
(pivoted <- contents("./inst/extdata/purpose.xlsx", "NNW WNW")[[1]])
```

We can identify each row of column headers, each column of row headers, and the
data cells, using any method.  Here, we use some
[dplyr](https://github.com/hadley/dplyr) and some base R functions.

```{r, echo = TRUE}
col_headers <- 
  pivoted %>%
  filter(row <= 3, !is.na(content)) %>%
  select(row, col, header = character) %>%
  split(.$row)
col_headers 

row_headers <- 
  pivoted %>%
  filter(col <= 3, !is.na(content)) %>%
  select(row, col, header = character) %>%
  split(.$col)
row_headers

datacells <- 
  pivoted %>%
  filter(row >= 4, col >= 4) %>%
  select(row, col, value = as.integer(content))
datacells
```

Using `unpivotr` functions, we associate the data cells with the headers, by
proximity in given compass directions.

```{r, echo = TRUE}
unpivoted <- 
  datacells %>%
  NNW(col_headers[[1]], "sex") %>%
  N(col_headers[[2]], "purpose") %>%
  WNW(row_headers[[1]], "education") %>% 
  W(row_headers[[2]], "age")
unpivoted
```

We can re-pivot the final data in R using `ftable()` to check that it has been
imported correctly.

```{r, echo = TRUE}
ftable(unpivoted, 
       row.vars = c("education", "age"),
       col.vars = c("sex", "purpose"))
read_excel("./inst/extdata/purpose.xlsx", "NNW WNW")
```

The functions `extend()` and `offset` can be used when selecting cells relative
to an intial anchor cell (or group of cells, called a 'bag').
