<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Small Multiples • unpivotr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">unpivotr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nacnudus/unpivotr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Small Multiples</h1>
                        <h4 class="author">Duncan Garmonsway</h4>
            
            <h4 class="date">2017-06-19</h4>
          </div>

    
    
<div class="contents">
<p>This vignette for the <a href="https://github.com/nacnudus/unpivotr">unpivotr</a> package demonstrates unpivoting multiple similar tables from a spreadsheet via the <a href="https://github.com/nacnudus/tidyxl">tidyxl</a> package. It is best read with the spreadsheet open in a spreadsheet program, e.g. Excel, LibreOffice Calc or Gnumeric.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The spreadsheet is from the famous Enron subpoena, made available by <a href="http://www.felienne.com/archives/3634">Felienne Hermans</a>, and has has previously been publicised by Jenny Bryan and David Robinson, in particular in Robinson’s article <a href="https://rpubs.com/dgrtwo/tidying-enron">‘Tidying an untidyable dataset’</a>.</p>
<p>Here’s a screenshot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="kw">system.file</span>(<span class="st">"extdata/enron-screenshot.png"</span>,
                                    <span class="dt">package =</span> <span class="st">"unpivotr"</span>))</code></pre></div>
<p><img src="/home/nacnudus/R/x86_64-pc-linux-gnu-library/3.4/unpivotr/extdata/enron-screenshot.png" width="850px"></p>
</div>
<div id="preparation" class="section level2">
<h2 class="hasAnchor">
<a href="#preparation" class="anchor"></a>Preparation</h2>
<p>This vignette uses several common packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(unpivotr)</code></pre></div>
<pre><code>## 
## Attaching package: 'unpivotr'</code></pre>
<pre><code>## The following object is masked from 'package:stats':
## 
##     offset</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyxl)
<span class="kw">library</span>(dplyr)</code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
<span class="kw">library</span>(purrr)</code></pre></div>
<pre><code>## 
## Attaching package: 'purrr'</code></pre>
<pre><code>## The following objects are masked from 'package:dplyr':
## 
##     contains, order_by</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)</code></pre></div>
<p>The spreadsheet is distributed with the unpivotr package, so can be loaded as a system file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata/enron.xlsx"</span>,
                    <span class="dt">package =</span> <span class="st">"unpivotr"</span>)</code></pre></div>
</div>
<div id="main" class="section level2">
<h2 class="hasAnchor">
<a href="#main" class="anchor"></a>Main</h2>
<div id="importing-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#importing-the-data" class="anchor"></a>Importing the data</h3>
<p>Spreadsheet cells are imported with the <code>tidy_xlsx()</code> function. By default, this returns all the sheets in the spreadsheet, as elements in a list, wrapped in another list of two elements: data and formats. Since there is only one sheet in this file, the data list has length 1, but it is still a list for the sake of consistency. Hence the sheet is accessed with the list subsetter <code>[[1]]</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cells &lt;-<span class="st"> </span><span class="kw">tidy_xlsx</span>(path)<span class="op">$</span>data[[<span class="dv">1</span>]]</code></pre></div>
<p>Cell formatting isn’t required for this vignette, but if it were, it would be imported via <code>tidy_xlsx(path)$formats</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">formatting &lt;-<span class="st"> </span><span class="kw">tidy_xlsx</span>(path)<span class="op">$</span>formats</code></pre></div>
</div>
<div id="importing-one-of-the-multiples" class="section level3">
<h3 class="hasAnchor">
<a href="#importing-one-of-the-multiples" class="anchor"></a>Importing one of the multiples</h3>
<p>The small multiples each have exactly one ‘Fixed Price’ header, so begin by selecting one of those.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fixed_price &lt;-<span class="st"> </span><span class="kw">filter</span>(cells, character <span class="op">==</span><span class="st"> "Fixed Price"</span>)[<span class="dv">1</span>, ]</code></pre></div>
<p>From that single cell, selct the three rows of the column headers of the first small multiple. The <code>split()</code> function below separates each row from one another, wrapping them together in a list. They are separated so that they can individually be joined to the data cells later. Another way to do this is to select each row one by one, assigning them to different variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">col_headers &lt;-
<span class="st">  </span>fixed_price <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/offset.html">offset_N</a></span>(cells, <span class="dt">n =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st">    </span><span class="co"># Offset up one row to "IF NWPL Rocky Mountains"</span>
<span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st">        </span><span class="co"># Extend to the right edge of the table</span>
<span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells, <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st">        </span><span class="co"># Extend down to the third row of the headers</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span><span class="st">   </span><span class="co"># Remove blanks</span>
<span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">value =</span> character) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Prepare for joining to data cells</span>
<span class="st">  </span><span class="kw">split</span>(.<span class="op">$</span>row)                  <span class="co"># Separate the row of headers into list elements</span>
col_headers</code></pre></div>
<pre><code>## $`14`
## # A tibble: 1 x 3
##     row   col                   value
##   &lt;int&gt; &lt;int&gt;                   &lt;chr&gt;
## 1    14    17 IF NWPL Rocky Mountains
## 
## $`15`
## # A tibble: 2 x 3
##     row   col       value
##   &lt;int&gt; &lt;int&gt;       &lt;chr&gt;
## 1    15    17 Fixed Price
## 2    15    19       Basis
## 
## $`16`
## # A tibble: 4 x 3
##     row   col value
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;
## 1    16    17   BID
## 2    16    18 OFFER
## 3    16    19   BID
## 4    16    20 OFFER</code></pre>
<p>Now select the data cells, starting from the ‘Fixed Price’ header again.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">datacells &lt;-
<span class="st">  </span>fixed_price <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/offset.html">offset_S</a></span>(cells, <span class="dt">n =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">4</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells,                       <span class="co"># Extend down to a blank row</span>
           <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content), <span class="co"># The formula detects blank cells</span>
           <span class="dt">edge =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st">          </span><span class="co"># Require the whole row to be blank</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span><span class="st">           </span><span class="co"># Remove remaining blanks</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">as.double</span>(content)) <span class="op">%&gt;%</span><span class="co"># Convert the values to double</span>
<span class="st">  </span><span class="kw">select</span>(row, col, value)               <span class="co"># Prepare for joining to headers</span>
<span class="kw">print</span>(datacells, <span class="dt">n =</span> <span class="ot">Inf</span>)</code></pre></div>
<pre><code>## # A tibble: 24 x 3
##      row   col      value
##    &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;
##  1    18    17  2.0600000
##  2    18    18  2.0800000
##  3    19    17  2.3950000
##  4    19    18  2.4150000
##  5    19    19 -0.5650000
##  6    19    20 -0.5450000
##  7    20    17  2.5940000
##  8    20    18  2.6140000
##  9    20    19 -0.4937500
## 10    20    20 -0.4737500
## 11    21    17  2.5812857
## 12    21    18  2.6012857
## 13    21    19 -0.5850000
## 14    21    20 -0.5650000
## 15    22    17  3.3560000
## 16    22    18  3.3760000
## 17    22    19 -0.2950000
## 18    22    20 -0.2750000
## 19    23    17  2.6340833
## 20    23    18  2.6540833
## 21    23    19 -0.5304167
## 22    23    20 -0.5104167
## 23    17    18  1.9100000
## 24    17    17  1.8900000</code></pre>
<p>Finally, bind the data cells to the column headers (this is the real magic). For more examples of how the compass directions work (the <code><a href="../reference/join_header.html">NNW()</a></code> and <code><a href="../reference/join_header.html">N()</a></code> functions below), see the vignette called <code>Compass Directions</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">datacells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">1</span>]]) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># This header isn't in every column</span>
<span class="st">  </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">2</span>]]) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Nor is this header</span>
<span class="st">  </span><span class="kw"><a href="../reference/join_header.html">N</a></span>(col_headers[[<span class="dv">3</span>]])    <span class="co"># But this one is</span></code></pre></div>
<pre><code>## # A tibble: 24 x 6
##      row   col  value.data                 i.value i.value.1 value.header
##    &lt;int&gt; &lt;int&gt;       &lt;chr&gt;                   &lt;chr&gt;     &lt;dbl&gt;        &lt;chr&gt;
##  1    18    17 Fixed Price IF NWPL Rocky Mountains   2.06000          BID
##  2    18    18 Fixed Price IF NWPL Rocky Mountains   2.08000        OFFER
##  3    19    17 Fixed Price IF NWPL Rocky Mountains   2.39500          BID
##  4    19    18 Fixed Price IF NWPL Rocky Mountains   2.41500        OFFER
##  5    19    19       Basis IF NWPL Rocky Mountains  -0.56500          BID
##  6    19    20       Basis IF NWPL Rocky Mountains  -0.54500        OFFER
##  7    20    17 Fixed Price IF NWPL Rocky Mountains   2.59400          BID
##  8    20    18 Fixed Price IF NWPL Rocky Mountains   2.61400        OFFER
##  9    20    19       Basis IF NWPL Rocky Mountains  -0.49375          BID
## 10    20    20       Basis IF NWPL Rocky Mountains  -0.47375        OFFER
## # ... with 14 more rows</code></pre>
</div>
<div id="importing-every-small-multiple-at-once" class="section level3">
<h3 class="hasAnchor">
<a href="#importing-every-small-multiple-at-once" class="anchor"></a>Importing every small multiple at once</h3>
<p>The code above, for a single multiple, can easily be adapted to import every one of the small multiples. Here this is done using the <a href="https://github.com/hadley/purrr"><code>purrr()</code></a> package to apply the code to each element of a list of ‘Fixed Price’ header cells.</p>
<p>Get all ten ‘Fixed Price’ headers, and separate each into its own list element. Since each cell has a unique combination of <code>row</code> and <code>col</code>, that combination can be used to separate the cells into list elements.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fixed_price &lt;-
<span class="st">  </span>cells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(character <span class="op">==</span><span class="st"> "Fixed Price"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">split</span>(<span class="kw">paste</span>(.<span class="op">$</span>row, .<span class="op">$</span>col))</code></pre></div>
<p>Adapt the code for a single multiple a ‘tidy’ function to tidy a general small multiple, starting from the ‘Fixed Price’ header. Here this is done by substituting <code>x</code> for <code>fixed_price</code>, and wrapping the three sections of code in a function. Everything else is the same.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tidy &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  col_headers &lt;-
<span class="st">    </span>x <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/offset.html">offset_N</a></span>(cells, <span class="dt">n =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells, <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(row, col, <span class="dt">value =</span> character) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">split</span>(.<span class="op">$</span>row)
  datacells &lt;-
<span class="st">    </span>x <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/offset.html">offset_S</a></span>(cells, <span class="dt">n =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">4</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells,
             <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content),
             <span class="dt">edge =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">as.double</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(row, col, value)
  datacells <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">1</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">2</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">N</a></span>(col_headers[[<span class="dv">3</span>]])
}</code></pre></div>
<p>Finally, map the ‘tidy’ function to each ‘Fixed Price’ header, and bind the results. into one data frame. The <a href="https://github.com/hadley/purrr"><code>purrr()</code></a> package is used here, but this could also be done with the <code>apply()</code> family of functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">map_df</span>(fixed_price, tidy) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(col, row) <span class="co"># See that, from row 39, the region changes, as it ought.</span></code></pre></div>
<pre><code>## # A tibble: 240 x 6
##      row   col  value.data                i.value i.value.1 value.header
##    &lt;int&gt; &lt;int&gt;       &lt;chr&gt;                  &lt;chr&gt;     &lt;dbl&gt;        &lt;chr&gt;
##  1    28     7 Fixed Price IF CIG Rocky Mountains  1.940000          BID
##  2    29     7 Fixed Price IF CIG Rocky Mountains  1.960000          BID
##  3    30     7 Fixed Price IF CIG Rocky Mountains  2.345000          BID
##  4    31     7 Fixed Price IF CIG Rocky Mountains  2.547750          BID
##  5    32     7 Fixed Price IF CIG Rocky Mountains  2.471286          BID
##  6    33     7 Fixed Price IF CIG Rocky Mountains  3.311000          BID
##  7    34     7 Fixed Price IF CIG Rocky Mountains  2.550750          BID
##  8    39     7 Fixed Price             AECO / NIT  2.376377          BID
##  9    40     7 Fixed Price             AECO / NIT  2.397635          BID
## 10    41     7 Fixed Price             AECO / NIT  2.551891          BID
## # ... with 230 more rows</code></pre>
</div>
<div id="joining-the-row-headers" class="section level3">
<h3 class="hasAnchor">
<a href="#joining-the-row-headers" class="anchor"></a>Joining the row headers</h3>
<p>So far, only the column headers have been joined, but there are also row headers on the left-hand side of the spreadsheet. The following code incorporates these into the final dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">row_headers &lt;-
<span class="st">  </span>cells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(character <span class="op">==</span><span class="st"> "Cash"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">split</span>(<span class="kw">paste</span>(.<span class="op">$</span>row, .<span class="op">$</span>col))

row_headers &lt;-
<span class="st">  </span><span class="kw">map_df</span>(row_headers,
    <span class="op">~</span><span class="st"> </span>.x <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells, <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content), <span class="dt">edge =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="co"># This concatenates the "Dec-20 to Mar-20" cells into one column.</span>
<span class="st">      </span><span class="co"># First it converts Excel dates, via R dates, into text.</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">character =</span> <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(character),
                                character,
                                <span class="kw">format</span>(<span class="kw">as.POSIXct</span>(<span class="kw">as.integer</span>(content) <span class="op">*</span><span class="st"> </span>(<span class="dv">60</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">24</span>),
                                       <span class="dt">origin=</span><span class="st">"1899-12-30"</span>,
                                       <span class="dt">tz=</span><span class="st">"GMT"</span>), <span class="st">"%b-%C"</span>))) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="co"># Then it concatentates them by row.</span>
<span class="st">      </span><span class="kw">select</span>(row, col, character) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">spread</span>(col, character, <span class="dt">fill =</span> <span class="st">""</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">col =</span> <span class="dv">1</span>, <span class="dt">value =</span> <span class="kw">str_trim</span>(<span class="kw">paste</span>(<span class="st">`</span><span class="dt">2</span><span class="st">`</span>, <span class="st">`</span><span class="dt">3</span><span class="st">`</span>, <span class="st">`</span><span class="dt">4</span><span class="st">`</span>))) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">select</span>(row, col, value))</code></pre></div>
<p>Since the single column of row headers applies to every row of every small multiple (unlike the column headers), a global <code>row_headers</code> variable can be joined to each small multiple by using a simple W() join. This is incorporated into the definition of <code>tidy()</code> below (see the bottom line).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tidy &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  col_headers &lt;-
<span class="st">    </span>x <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/offset.html">offset_N</a></span>(cells, <span class="dt">n =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells, <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(row, col, <span class="dt">value =</span> character) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">split</span>(.<span class="op">$</span>row)
  datacells &lt;-
<span class="st">    </span>x <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/offset.html">offset_S</a></span>(cells, <span class="dt">n =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">4</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells,
             <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content),
             <span class="dt">edge =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">as.double</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(row, col, value)
  datacells <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">1</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">2</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">N</a></span>(col_headers[[<span class="dv">3</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">W</a></span>(row_headers) <span class="co"># This is the only new line</span>
}

<span class="kw">map_df</span>(fixed_price, tidy) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(col, row) <span class="co"># See that, from row 39, the context loops, as it ought.</span></code></pre></div>
<pre><code>## # A tibble: 240 x 7
##      row   col  value.data                i.value i.value.1 value.header
##    &lt;int&gt; &lt;int&gt;       &lt;chr&gt;                  &lt;chr&gt;     &lt;dbl&gt;        &lt;chr&gt;
##  1    28     7 Fixed Price IF CIG Rocky Mountains  1.940000          BID
##  2    29     7 Fixed Price IF CIG Rocky Mountains  1.960000          BID
##  3    30     7 Fixed Price IF CIG Rocky Mountains  2.345000          BID
##  4    31     7 Fixed Price IF CIG Rocky Mountains  2.547750          BID
##  5    32     7 Fixed Price IF CIG Rocky Mountains  2.471286          BID
##  6    33     7 Fixed Price IF CIG Rocky Mountains  3.311000          BID
##  7    34     7 Fixed Price IF CIG Rocky Mountains  2.550750          BID
##  8    39     7 Fixed Price             AECO / NIT  2.376377          BID
##  9    40     7 Fixed Price             AECO / NIT  2.397635          BID
## 10    41     7 Fixed Price             AECO / NIT  2.551891          BID
## # ... with 230 more rows, and 1 more variables: value &lt;chr&gt;</code></pre>
</div>
</div>
<div id="line-code-listing" class="section level2">
<h2 class="hasAnchor">
<a href="#line-code-listing" class="anchor"></a>57-line code listing</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(unpivotr)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(tidyr)
<span class="kw">library</span>(purrr)
<span class="kw">library</span>(stringr)

path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata/enron.xlsx"</span>,
                    <span class="dt">package =</span> <span class="st">"unpivotr"</span>)
cells &lt;-<span class="st"> </span><span class="kw">tidy_xlsx</span>(path)<span class="op">$</span>[[<span class="dv">1</span>]]

fixed_price &lt;-
<span class="st">  </span>cells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(character <span class="op">==</span><span class="st"> "Fixed Price"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">split</span>(<span class="kw">paste</span>(.<span class="op">$</span>row, .<span class="op">$</span>col))

row_headers &lt;-
<span class="st">  </span>cells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(character <span class="op">==</span><span class="st"> "Cash"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">split</span>(<span class="kw">paste</span>(.<span class="op">$</span>row, .<span class="op">$</span>col))

row_headers &lt;-
<span class="st">  </span><span class="kw">map_df</span>(row_headers,
    <span class="op">~</span><span class="st"> </span>.x <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells, <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content), <span class="dt">edge =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">character =</span> <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(character),
                                character,
                                <span class="kw">format</span>(<span class="kw">as.POSIXct</span>(<span class="kw">as.integer</span>(content) <span class="op">*</span><span class="st"> </span>(<span class="dv">60</span><span class="op">*</span><span class="dv">60</span><span class="op">*</span><span class="dv">24</span>),
                                       <span class="dt">origin=</span><span class="st">"1899-12-30"</span>,
                                       <span class="dt">tz=</span><span class="st">"GMT"</span>), <span class="st">"%b-%C"</span>))) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">select</span>(row, col, character) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">spread</span>(col, character, <span class="dt">fill =</span> <span class="st">""</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">mutate</span>(<span class="dt">col =</span> <span class="dv">1</span>, <span class="dt">value =</span> <span class="kw">str_trim</span>(<span class="kw">paste</span>(<span class="st">`</span><span class="dt">2</span><span class="st">`</span>, <span class="st">`</span><span class="dt">3</span><span class="st">`</span>, <span class="st">`</span><span class="dt">4</span><span class="st">`</span>))) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">select</span>(row, col, value))

tidy &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  col_headers &lt;-
<span class="st">    </span>x <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/offset.html">offset_N</a></span>(cells, <span class="dt">n =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells, <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(row, col, <span class="dt">value =</span> character) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">split</span>(.<span class="op">$</span>row)
  datacells &lt;-
<span class="st">    </span>x <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/offset.html">offset_S</a></span>(cells, <span class="dt">n =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_E</a></span>(cells, <span class="dv">4</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/extend.html">extend_S</a></span>(cells,
             <span class="dt">boundary =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(content),
             <span class="dt">edge =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">as.double</span>(content)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(row, col, value)
  datacells <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">1</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">NNW</a></span>(col_headers[[<span class="dv">2</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">N</a></span>(col_headers[[<span class="dv">3</span>]]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/join_header.html">W</a></span>(row_headers) <span class="co"># This is the only new line</span>
}

<span class="kw">map_df</span>(fixed_price, tidy)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#preparation">Preparation</a></li>
      <li><a href="#main">Main</a></li>
      <li><a href="#line-code-listing">57-line code listing</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Duncan Garmonsway.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
